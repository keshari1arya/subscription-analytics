name: Security & Compliance Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: src/SubscriptionAnalytics.Web/package-lock.json
        
    - name: Install dependencies
      run: |
        cd src/SubscriptionAnalytics.Web
        npm ci
        
    - name: Install Snyk
      run: npm install -g snyk
      
    - name: Install Semgrep
      run: |
        curl -L https://github.com/returntocorp/semgrep/releases/latest/download/semgrep-v1.128.0-ubuntu-20.04.tgz | tar -xz
        sudo mv semgrep-v1.128.0-ubuntu-20.04/semgrep /usr/local/bin/
        
    - name: Run Snyk security scan
      run: |
        cd src/SubscriptionAnalytics.Web
        snyk test --json > ../../snyk-results.json || true
      continue-on-error: true
      
    - name: Run Semgrep static analysis
      run: |
        semgrep scan --config .semgrep.yml --json > semgrep-results.json || true
      continue-on-error: true
      
    - name: Run NPM audit
      run: |
        cd src/SubscriptionAnalytics.Web
        npm audit --json > ../../npm-audit-results.json || true
      continue-on-error: true
      
    - name: GDPR Compliance Check
      run: |
        grep -r -i "email\|phone\|ssn\|credit.*card\|password" src/ --include="*.cs" --include="*.ts" --include="*.js" > gdpr-pii-detection.txt || true
      continue-on-error: true
      
    - name: SOC2 Compliance Check
      run: |
        grep -r -i "console\.log\|console\.write\|debug.*log" src/ --include="*.cs" --include="*.ts" --include="*.js" > soc2-logging-detection.txt || true
      continue-on-error: true
      
    - name: Upload security reports
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          snyk-results.json
          semgrep-results.json
          npm-audit-results.json
          gdpr-pii-detection.txt
          soc2-logging-detection.txt
        retention-days: 30
        
    - name: Comment PR with security findings
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          let comment = '## 🔒 Security & Compliance Scan Results\n\n';
          
          // Check Snyk results
          if (fs.existsSync('snyk-results.json')) {
            const snykData = JSON.parse(fs.readFileSync('snyk-results.json', 'utf8'));
            if (snykData.vulnerabilities && snykData.vulnerabilities.length > 0) {
              comment += `### ⚠️ Snyk found ${snykData.vulnerabilities.length} vulnerabilities\n`;
              snykData.vulnerabilities.slice(0, 5).forEach(vuln => {
                comment += `- **${vuln.severity}**: ${vuln.title}\n`;
              });
              if (snykData.vulnerabilities.length > 5) {
                comment += `- ... and ${snykData.vulnerabilities.length - 5} more\n`;
              }
            } else {
              comment += '### ✅ Snyk: No vulnerabilities found\n';
            }
          }
          
          // Check Semgrep results
          if (fs.existsSync('semgrep-results.json')) {
            const semgrepData = JSON.parse(fs.readFileSync('semgrep-results.json', 'utf8'));
            if (semgrepData.results && semgrepData.results.length > 0) {
              comment += `\n### ⚠️ Semgrep found ${semgrepData.results.length} issues\n`;
              semgrepData.results.slice(0, 5).forEach(result => {
                comment += `- **${result.extra.severity}**: ${result.extra.message} (${result.path}:${result.start.line})\n`;
              });
              if (semgrepData.results.length > 5) {
                comment += `- ... and ${semgrepData.results.length - 5} more\n`;
              }
            } else {
              comment += '\n### ✅ Semgrep: No issues found\n';
            }
          }
          
          comment += '\n---\n*Security reports are available as artifacts*';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          }); 